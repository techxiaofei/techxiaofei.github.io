<!doctype html>
<html lang="en-us">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="referrer" content="no-referrer-when-downgrade">
    

    <title>后端面试之Linux-cp和mv命令的区别 | Leftpocket的个人博客</title>
    <meta property="og:title" content="后端面试之Linux-cp和mv命令的区别 - Leftpocket的个人博客">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2021-12-07T00:00:00&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2021-12-07T00:00:00&#43;08:00'>
        
    <meta name="Keywords" content="[Linux]">
    <meta name="description" content="后端面试之Linux-cp和mv命令的区别">
        
    <meta name="author" content="leftpocket">
    <meta property="og:url" content="https://left-pocket.github.io/post/linux/cp/">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    <meta name="baidu-site-verification" content="code-swx03nFBNS" />
    <meta name="google-site-verification" content="sGfWBA2Wby1_gxJO3xmOtvpAOU2cCyhwXuU-2m4u75Y" />

    
    <script data-ad-client="ca-pub-6791708134711137" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6791708134711137"
     crossorigin="anonymous"></script>
    
    
    
    
    
        <link rel="stylesheet" href='/css/douban.css'>
    
        <link rel="stylesheet" href='/css/other.css'>
    

    
    <meta name="baidu-site-verification" content="code-swx03nFBNS" />
</head>


<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://left-pocket.github.io">
                        Leftpocket的个人博客
                    </a>
                
                <p class="description">码农在新加坡</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://left-pocket.github.io">首页</a>
                    
                    <a  href="https://left-pocket.github.io/archives/" title="归档">归档</a>
                    
                    <a  href="https://left-pocket.github.io/about/" title="关于我">关于我</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    
    <article class="post">
        <header>
            <h1 class="post-title">后端面试之Linux-cp和mv命令的区别</h1>
        </header>
        <date class="post-meta meta-date">
            2021年12月7日
        </date>
        
        <div class="post-meta">
            <span>|</span>
            
            <span class="meta-category"><a href='/categories/Linux'>Linux</a></span>
            
        </div>
        
        
        <div class="post-meta">
            <span id="busuanzi_container_page_pv">|<span id="busuanzi_value_page_pv"></span><span>
                    阅读</span></span>
        </div>
        
        
        <div class="post-content">
            <h1 id="背景">背景</h1>
<p>如果你突然被面试官问：cp和mv这两个linux的命令有什么区别？<br>
你会不会一脸懵逼，cp不就是复制，mv不就是移动吗，还能有什么区别？<br>
如果你也是这么想，那么这篇文章适合你。</p>
<h1 id="inode">inode</h1>
<p>了解文件操作命令例如<code>cp</code>、<code>mv</code>、<code>rm</code>的底层原理时，需要先了解 linux 中文件系统的基本原理。</p>
<p>在linux系统中，文件系统对文件的存储和访问是通过一种被称为<code>inode</code>即i节点的机制来实现的。</p>
<p>为什么需要inode呢？<br>
文件数据存储在硬盘上，硬盘的最小存储单位叫做&quot;扇区&quot;（512Bytes）。OS读取硬盘的时候，为了提高效率会一次性读取一个&quot;块&quot;（8*扇区=4K）。<br>
所以一个大文件的数据内容在磁盘上可能不是连续空间的，就需要inode来把各个<code>Block</code>串联起来。</p>
<p>每个文件都对应一个 i 节点，i 节点存储了除<code>文件名</code>和<code>文件内容</code>之外的所有信息。</p>
<p>inode（index node）表中包含文件系统所有文件列表，一个节点 （索引节点）是在一个表项，包含有关文件的信息（ 元数据 ），包括：文件类型，权限，UID，GID、链接数（指向这个文件名路径名称个数）、该文件的大小和不同的时间戳、指向磁盘上文件的数据块指针、有关文件的其他数据。</p>
<p>
        <img class="mx-auto" alt="inode" src="/img/linux/linux_inode.png" />   
    </p>
<p>了解inode的基本信息之后，我们再看看<code>cp</code>, <code>mv</code>有什么区别。</p>
<h1 id="cp">cp</h1>
<h3 id="目标文件不存在时">目标文件不存在时</h3>
<p>当<code>dest.txt</code>不存在时，执行<code>cp src.txt dest.txt</code>。<br>
可以发现<code>dest.txt</code>和<code>src.txt</code>的inode不一样，也就是用open()新建一个文件<code>dest.txt</code>，然后读取<code>src.txt</code>的数据再写入<code>dest.txt</code>。</p>
<p><strong>cp前：</strong></p>
<ul>
<li>src.txt: <code>Inode: 34643179</code></li>
</ul>
<p><strong>cp后：</strong></p>
<ul>
<li>dest.txt: <code>Inode: 34257722</code></li>
</ul>
<pre tabindex="0"><code>[root@instance-1 blog]# strace cp source.txt destination.txt 2&gt;&amp;1 | egrep 'source.txt|destination.txt'
execve(&quot;/bin/cp&quot;, [&quot;cp&quot;, &quot;source.txt&quot;, &quot;destination.txt&quot;], 0x7ffd8f1f3ea0 /* 23 vars */) = 0
stat(&quot;destination.txt&quot;, 0x7fff021b0040) = -1 ENOENT (No such file or directory)
stat(&quot;source.txt&quot;, {st_mode=S_IFREG|0644, st_size=13, ...}) = 0
stat(&quot;destination.txt&quot;, 0x7fff021afda0) = -1 ENOENT (No such file or directory)
open(&quot;source.txt&quot;, O_RDONLY)            = 3
open(&quot;destination.txt&quot;, O_WRONLY|O_CREAT|O_EXCL, 0644) = 4
</code></pre><h3 id="目标文件存在时">目标文件存在时</h3>
<p>此时<code>dest.txt</code>已经存在，再次执行<code>cp src.txt dest.txt</code>。<br>
可以发现<code>dest.txt</code>跟上次执行的<code>dest.txt</code>的inode没有变化，同时看open()的参数也可以看出：先清空了<code>dest.txt</code>的内容，再把新的内容写入目标文件。没有文件的删除和创建，所以inode没有变化。</p>
<p><strong>cp前：</strong></p>
<ul>
<li>src.txt: <code>Inode: 34643179</code></li>
<li>dest.txt: <code>Inode: 34257722</code></li>
</ul>
<p><strong>cp后：</strong></p>
<ul>
<li>dest.txt: <code>Inode: 34257722</code></li>
</ul>
<pre tabindex="0"><code>[root@instance-1 blog]# strace cp source.txt destination.txt 2&gt;&amp;1 | egrep 'source.txt|destination.txt'
execve(&quot;/bin/cp&quot;, [&quot;cp&quot;, &quot;source.txt&quot;, &quot;destination.txt&quot;], 0x7ffd4bfd93e0 /* 23 vars */) = 0
stat(&quot;destination.txt&quot;, {st_mode=S_IFREG|0644, st_size=13, ...}) = 0
stat(&quot;source.txt&quot;, {st_mode=S_IFREG|0644, st_size=13, ...}) = 0
stat(&quot;destination.txt&quot;, {st_mode=S_IFREG|0644, st_size=13, ...}) = 0
open(&quot;source.txt&quot;, O_RDONLY)            = 3
open(&quot;destination.txt&quot;, O_WRONLY|O_TRUNC) = 4
</code></pre><h3 id="结论">结论</h3>
<ul>
<li>cp调用open系统函数，只会复制文件数据，不会复制inode索引节点的元数据。</li>
</ul>
<h1 id="mv">mv</h1>
<h3 id="目标文件不存在时-1">目标文件不存在时</h3>
<p>当目标文件<code>dest.txt</code>不存在时，执行<code>mv src.txt dest.txt</code>。<br>
可以发现<code>dest.txt</code>和<code>src.txt</code>的inode一样，底层调用了rename()，inode信息与<code>src.txt</code>的索引节点保持一致。<br>
注：centos 7.5以上的版本，调用<code>renameat2</code>函数，7.5及以下的函数，依旧调用<code>rename</code>函数，没有本质的区别。</p>
<p><strong>mv前：</strong></p>
<ul>
<li>src.txt: <code>Inode: 34643179</code></li>
</ul>
<p><strong>mv后：</strong></p>
<ul>
<li>dest.txt: <code>Inode: 34643179</code></li>
</ul>
<pre tabindex="0"><code>[root@instance-1 blog]# strace mv src.txt dest.txt 2&gt;&amp;1 | egrep 'src.txt|dest.txt'
execve(&quot;/bin/mv&quot;, [&quot;mv&quot;, &quot;src.txt&quot;, &quot;dest.txt&quot;], 0x7ffd71529810 /* 23 vars */) = 0
stat(&quot;dest.txt&quot;, 0x7ffdb24b0fe0)        = -1 ENOENT (No such file or directory)
lstat(&quot;src.txt&quot;, {st_mode=S_IFREG|0644, st_size=13, ...}) = 0
lstat(&quot;dest.txt&quot;, 0x7ffdb24b0c90)       = -1 ENOENT (No such file or directory)
renameat2(AT_FDCWD, &quot;src.txt&quot;, AT_FDCWD, &quot;dest.txt&quot;, 0) = 0
</code></pre><h3 id="目标文件存在时-1">目标文件存在时</h3>
<p>当目标文件<code>dest.txt</code>存在时，执行<code>mv src.txt dest.txt</code>。<br>
可以发现<code>dest.txt</code>和<code>src.txt</code>的inode一样（之前的<code>dest.txt</code>的inode不见了），底层调用了rename()，inode变为<code>src.txt</code>的索引节点。</p>
<p><strong>mv前：</strong></p>
<ul>
<li>src.txt: <code>Inode: 34643179</code></li>
<li>dest.txt: <code>Inode: 34257722</code></li>
</ul>
<p><strong>mv后：</strong></p>
<ul>
<li>dest.txt: <code>Inode: 34643179</code></li>
</ul>
<pre tabindex="0"><code>[root@instance-1 blog]# strace mv src.txt dest.txt 2&gt;&amp;1 | egrep 'src.txt|dest.txt'
execve(&quot;/bin/mv&quot;, [&quot;mv&quot;, &quot;src.txt&quot;, &quot;dest.txt&quot;], 0x7ffeef1ed240 /* 23 vars */) = 0
stat(&quot;dest.txt&quot;, {st_mode=S_IFREG|0644, st_size=13, ...}) = 0
lstat(&quot;src.txt&quot;, {st_mode=S_IFREG|0644, st_size=13, ...}) = 0
lstat(&quot;dest.txt&quot;, {st_mode=S_IFREG|0644, st_size=13, ...}) = 0
renameat2(AT_FDCWD, &quot;src.txt&quot;, AT_FDCWD, &quot;dest.txt&quot;, 0) = 0
</code></pre><h3 id="结论-1">结论</h3>
<ul>
<li>mv调用rename系统调用，把<code>src.txt</code>重命名为目标文件，会将存储于inode索引节点上的文件元信息也移动到新文件中。</li>
</ul>
<h1 id="rm">rm</h1>
<p>在Linux中，要真正删除一个文件，需要满足两个条件：</p>
<ul>
<li>链接数为0</li>
<li>没有进程打开该文件
系统调用unlink()是移除目标文件的一个链接。可以发现rm底层调用的其实就是unlink()</li>
</ul>
<pre tabindex="0"><code>[root@instance-1 blog]# strace rm src.txt 2&gt;&amp;1 | egrep 'src.txt'
execve(&quot;/bin/rm&quot;, [&quot;rm&quot;, &quot;src.txt&quot;], 0x7fffbf900e58 /* 23 vars */) = 0
newfstatat(AT_FDCWD, &quot;src.txt&quot;, {st_mode=S_IFREG|0644, st_size=13, ...}, AT_SYMLINK_NOFOLLOW) = 0
unlinkat(AT_FDCWD, &quot;src.txt&quot;, 0)        = 0
</code></pre><h3 id="unlink系统调用">unlink系统调用</h3>
<p>从文件系统中删除一个名称。如果名称是文件的最后一个连接，并且没有其它进程将文件打开，名称对应的文件会实际被删除。<br>
如果文件仍旧是打开的，或者是被进程占用，其内容不会被删除。只有当进程关闭该文件或终止时(这种情况下，内核关闭该进程所打开的全部文件)，该文件的内容才会被删除。</p>
<p>所以你可能会遇到，一个进程在读写文件时，你发现磁盘空间不足，使用rm删除文件，却发现磁盘空间却没有释放的情况。
使用<code>lsof | grep deleted</code>可以查看占用的进程。kill进程之后，文件才能真正的被删除。</p>
<h3 id="结论-2">结论</h3>
<ul>
<li>rm调用unlink系统调用，只有当所有的进程都不占用此文件的时候，才会真正的从磁盘删除。</li>
</ul>
<h1 id="替换可执行程序">替换可执行程序</h1>
<p>不知道你还记不记得你是怎么替换可执行文件的，一般来说：</p>
<p>可当你使用</p>
<pre tabindex="0"><code>cp new_backend_server backend_server
</code></pre><p>的时候，提示<code>Text file busy</code>。
为什么呢，因为你这个文件正在被使用，当你清空并写入的时候，它能感知到修改，修改文件内容很可能导致程序逻辑错误甚至崩溃。所以禁止你对正在使用的文件执行cp替换。</p>
<p>当你执行：</p>
<pre tabindex="0"><code>rm backend_server
mv new_backend_server backend_server
service restart backend_server
</code></pre><p>就可以成功替换新的文件。<br>
这又是为什么呢，因为当你使用<code>rm&amp;mv</code>的时候是直接unlink旧的文件，由于文件被进程占用，实际上并没有删除，当你把新的文件mv到当前文件的时候，直接进行rename。并不会影响当前被进程占用的那个文件（新旧的inode不同，只是名字一样）。当你重启的时候，才会释放旧的文件，使用新的文件。</p>
<h1 id="总结">总结</h1>
<p>最后总结一下：</p>
<ul>
<li>cp调用open系统函数，只会复制文件数据，不会复制inode索引节点的元数据。（不改变inode）</li>
<li>mv调用rename系统调用，把<code>src.txt</code>重命名为目标文件，会将存储于inode索引节点上的文件元信息也移动到新文件中。（改变inode）</li>
<li>rm调用unlink系统调用，只有当所有的进程都不占用此文件的时候，才会真正的从磁盘删除。</li>
</ul>
<p>&lt;全文完&gt;</p>
<p>欢迎关注我的微信公众号：<strong>码农在新加坡</strong>，有更多好的技术分享。

        <img class="mx-auto" alt="pic" src="/img/personal/qrcode_2.png" />   
    </p>

        </div>

        


        


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='/tags/Linux'>Linux</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "left-pocket/left-pocket.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
</div>

                    <footer id="footer">
    <div>
        &copy; 2021 <a href="https://left-pocket.github.io">Leftpocket的个人博客 By leftpocket</a>
        
    </div>
    <br />
    <div>
        <div class="github-badge">
            <a href="https://gohugo.io/" target="_black" rel="nofollow"><span class="badge-subject">Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
        </div>
        <div class="github-badge">
            <a href="https://left-pocket.github.io/" target="_black"><span class="badge-subject">Design by</span><span class="badge-value bg-brightgreen">Leftpocket</span></a>
        </div>
    </div>
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>



    <script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




    <script src='/js/douban.js'></script>

                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='https://left-pocket.github.io/search/' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://left-pocket.github.io">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://left-pocket.github.io/post/redis/multithreading/" title="一文看懂Redis 6.0多线程IO">一文看懂Redis 6.0多线程IO</a>
    </li>
    
    <li>
        <a href="https://left-pocket.github.io/post/linux/cp/" title="后端面试之Linux-cp和mv命令的区别">后端面试之Linux-cp和mv命令的区别</a>
    </li>
    
    <li>
        <a href="https://left-pocket.github.io/post/mysql/table/" title="MySQL对于千万级的大表要怎么优化？">MySQL对于千万级的大表要怎么优化？</a>
    </li>
    
    <li>
        <a href="https://left-pocket.github.io/post/backend/game_server/" title="游戏服务器和普通服务器的区别">游戏服务器和普通服务器的区别</a>
    </li>
    
    <li>
        <a href="https://left-pocket.github.io/post/mysql/innodb/" title="后端面试之MySQL-InnoDB一颗B&#43;树可以存放多少行数据？">后端面试之MySQL-InnoDB一颗B&#43;树可以存放多少行数据？</a>
    </li>
    
    <li>
        <a href="https://left-pocket.github.io/post/hugo/hugo_dns/" title="从零开始搭建个人博客（五）- 申请免费域名并绑定到个人博客">从零开始搭建个人博客（五）- 申请免费域名并绑定到个人博客</a>
    </li>
    
    <li>
        <a href="https://left-pocket.github.io/post/hugo/hugo_vercel/" title="从零开始搭建个人博客（四）- hugo自动部署到vercel">从零开始搭建个人博客（四）- hugo自动部署到vercel</a>
    </li>
    
    <li>
        <a href="https://left-pocket.github.io/post/hugo/hugo_advanced/" title="从零开始搭建个人博客（三）- hugo高级配置，让博客更亮眼">从零开始搭建个人博客（三）- hugo高级配置，让博客更亮眼</a>
    </li>
    
    <li>
        <a href="https://left-pocket.github.io/post/hugo/hugo_github/" title="从零开始搭建个人博客（二）- 把hugo博客托管到github上">从零开始搭建个人博客（二）- 把hugo博客托管到github上</a>
    </li>
    
    <li>
        <a href="https://left-pocket.github.io/post/hugo/hugo_creation/" title="从零开始搭建个人博客（一）- 使用hugo搭建个人博客">从零开始搭建个人博客（一）- 使用hugo搭建个人博客</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories/'>分类</a></h3>
<ul class="widget-list">
    
    <li><a href="https://left-pocket.github.io/categories/Golang/">Golang (4)</a></li>
    
    <li><a href="https://left-pocket.github.io/categories/Linux/">Linux (1)</a></li>
    
    <li><a href="https://left-pocket.github.io/categories/MySQL/">MySQL (5)</a></li>
    
    <li><a href="https://left-pocket.github.io/categories/Others/">Others (1)</a></li>
    
    <li><a href="https://left-pocket.github.io/categories/Redis/">Redis (3)</a></li>
    
    <li><a href="https://left-pocket.github.io/categories/c&#43;&#43;/">c&#43;&#43; (3)</a></li>
    
    <li><a href="https://left-pocket.github.io/categories/git/">git (1)</a></li>
    
    <li><a href="https://left-pocket.github.io/categories/hugo/">hugo (6)</a></li>
    
    <li><a href="https://left-pocket.github.io/categories/leetcode/">leetcode (1)</a></li>
    
    <li><a href="https://left-pocket.github.io/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发 (2)</a></li>
    
    <li><a href="https://left-pocket.github.io/categories/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/">系统设计 (4)</a></li>
    
    <li><a href="https://left-pocket.github.io/categories/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/">网络编程 (1)</a></li>
    
    <li><a href="https://left-pocket.github.io/categories/%E9%9D%A2%E8%AF%95/">面试 (2)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags/'>标签</a></h3>
<div class="tagcloud">
    
    <a href="https://left-pocket.github.io/tags/Golang/">Golang</a>
    
    <a href="https://left-pocket.github.io/tags/Linux/">Linux</a>
    
    <a href="https://left-pocket.github.io/tags/MySQL/">MySQL</a>
    
    <a href="https://left-pocket.github.io/tags/Redis/">Redis</a>
    
    <a href="https://left-pocket.github.io/tags/c&#43;&#43;/">c&#43;&#43;</a>
    
    <a href="https://left-pocket.github.io/tags/git/">git</a>
    
    <a href="https://left-pocket.github.io/tags/hugo/">hugo</a>
    
    <a href="https://left-pocket.github.io/tags/leetcode/">leetcode</a>
    
    <a href="https://left-pocket.github.io/tags/vscode/">vscode</a>
    
    <a href="https://left-pocket.github.io/tags/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a>
    
    <a href="https://left-pocket.github.io/tags/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/">系统设计</a>
    
    <a href="https://left-pocket.github.io/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/">网络编程</a>
    
    <a href="https://left-pocket.github.io/tags/%E9%9D%A2%E8%AF%95/">面试</a>
    
</div>
    </section>

    
<section class="widget">
    <h3 class="widget-title">友情链接</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="https://left-pocket.github.io/about/" title="关于我" style="color:#0000FF;">关于我-微信及公众号</a>
        </li>
        
        <li>
            <a target="_blank" href="https://www.zhihu.com/people/left-pocket" title="Leftpocket的知乎" style="color:#0000FF;">Leftpocket的知乎</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="https://left-pocket.github.io/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
</body>

</html>