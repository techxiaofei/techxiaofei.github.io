<!doctype html>
<html lang="en-us">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="referrer" content="no-referrer-when-downgrade">
    

    <title>后端面试之MySQL-什么是回表查询和覆盖索引 | Leftpocket的个人博客</title>
    <meta property="og:title" content="后端面试之MySQL-什么是回表查询和覆盖索引 - Leftpocket的个人博客">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2021-11-26T00:00:00&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2021-11-26T00:00:00&#43;08:00'>
        
    <meta name="Keywords" content="[MySQL 回表查询]">
    <meta name="description" content="后端面试之MySQL-什么是回表查询和覆盖索引">
        
    <meta name="author" content="leftpocket">
    <meta property="og:url" content="https://left-pocket.github.io/post/mysql/covering_index/">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    <script data-ad-client="ca-pub-8922621224955535" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    
    
    
    
    
    
        <link rel="stylesheet" href='/css/custom.css'>
    

    
    <meta name="baidu-site-verification" content="code-swx03nFBNS" />
</head>


<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://left-pocket.github.io">
                        Leftpocket的个人博客
                    </a>
                
                <p class="description">码农在新加坡</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://left-pocket.github.io">首页</a>
                    
                    <a  href="https://left-pocket.github.io/archives/" title="归档">归档</a>
                    
                    <a  href="https://left-pocket.github.io/about/" title="关于我">关于我</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    
    <article class="post">
        <header>
            <h1 class="post-title">后端面试之MySQL-什么是回表查询和覆盖索引</h1>
        </header>
        <date class="post-meta meta-date">
            2021年11月26日
        </date>
        
        <div class="post-meta">
            <span>|</span>
            
            <span class="meta-category"><a href='/categories/mysql'>MySQL</a></span>
            
        </div>
        
        
        <div class="post-meta">
            <span id="busuanzi_container_page_pv">|<span id="busuanzi_value_page_pv"></span><span>
                    阅读</span></span>
        </div>
        
        
        <div class="post-content">
            <p>原文地址：<a href="https://left-pocket.github.io/post/mysql/covering_index/">https://left-pocket.github.io</a></p>
<p><strong>后端面试</strong>系列将剖析后端面试中常考技术点，用尽量短的篇幅把一个一个技术点呈现出来。</p>
<h1 id="背景">背景</h1>
<p>关于回表查询，是MySQL里面一个非常重要的知识点。理解回表查询，让你在实际项目中操作数据库的时候会有更好的性能考虑。<br>
回表查询也是我面试必考的一个基础知识。</p>
<h1 id="什么是回表查询">什么是回表查询？</h1>
<p>这先要从InnoDB的索引实现说起，InnoDB有两大类索引：</p>
<ul>
<li>聚集索引(clustered index) - 非叶子节点存储的是表的主键；叶子节点存储着当前主键对应的行记录；</li>
<li>普通索引(secondary index) - 非叶子节点存储的是自己设置的索引字段对应的值(如果是联合索引，那就是联合索引的几个字段对应的值)；叶子节点，只存储当前记录对应的主键ID（聚集索引的非叶子结点的值）。</li>
</ul>
<p>普通索引也叫非聚集索引。</p>
<p>InnoDB必须要有，且只有一个聚集索引：</p>
<ol>
<li>如果表定义了PK，则PK就是聚集索引；</li>
<li>如果表没有定义PK，则第一个not NULL unique列是聚集索引；</li>
<li>否则，InnoDB会创建一个隐藏的row-id作为聚集索引；</li>
</ol>
<p>我们假设有一个表 <code>student_tab</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#f92672">`</span>student_tab<span style="color:#f92672">`</span>(
   <span style="color:#f92672">`</span>id<span style="color:#f92672">`</span> INT UNSIGNED AUTO_INCREMENT,
   <span style="color:#f92672">`</span>name<span style="color:#f92672">`</span> VARCHAR(<span style="color:#ae81ff">32</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
   <span style="color:#f92672">`</span>age<span style="color:#f92672">`</span> INT UNSIGNED <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
   <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span> ( <span style="color:#f92672">`</span>id<span style="color:#f92672">`</span> ),
   <span style="color:#66d9ef">INDEX</span> <span style="color:#f92672">`</span>idx_name<span style="color:#f92672">`</span> (<span style="color:#f92672">`</span>name<span style="color:#f92672">`</span>)
)ENGINE<span style="color:#f92672">=</span>InnoDB <span style="color:#66d9ef">DEFAULT</span> CHARSET<span style="color:#f92672">=</span>utf8;
</code></pre></div><p>注：</p>
<ul>
<li>主键（PK）: id （聚集索引）</li>
<li>普通索引：name （非聚集索引）</li>
</ul>
<h3 id="什么时候回表">什么时候回表？</h3>
<p>当我们查询语句如下的时候：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">select</span> id, name, age <span style="color:#66d9ef">from</span> student_tab <span style="color:#66d9ef">where</span> name <span style="color:#f92672">=</span> <span style="color:#f92672">`</span>Bob<span style="color:#f92672">`</span>;
</code></pre></div><p>的时候，就会出现 <strong>回表查询</strong>。</p>
<p>为什么呢？<br>
因为：普通索引叶子结点只储存当前记录对应的主键ID。我们通过普通索引 <code>name = Bob</code> 查找记录，找到最终 <code>id = 13</code>， 但是我们最终返回的数据还有 <code>age</code>，这个时候只通过普通索引无法返回我们需要的所有数据，就需要回到聚集索引里面查找。
这就是 <strong>回表查询</strong>。</p>
<p>
        <img class="mx-auto" alt="回表" src="/img/mysql/covering_index.png" />   
    </p>
<h3 id="使用普通索引查询都是回表查询吗">使用普通索引查询都是回表查询吗？</h3>
<p>不是的。<br>
当你的查询条件为这样：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">select</span> id, name <span style="color:#66d9ef">from</span> student_tab <span style="color:#66d9ef">where</span> name <span style="color:#f92672">=</span> <span style="color:#f92672">`</span>Bob<span style="color:#f92672">`</span>;
</code></pre></div><p>需要的数据 <code>id, name</code> 通过普通索引都可以得到，就不会回表。</p>
<h3 id="怎么避免回表查询呢">怎么避免回表查询呢？</h3>
<p>如果我又想需要age，又不想回表查询，该怎么办呢？
简单， 给 name和age建立一个联合索引替换掉 <code>idx_name</code> 索引。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">INDEX</span> <span style="color:#f92672">`</span>idx_name_age<span style="color:#f92672">`</span> (<span style="color:#f92672">`</span>name<span style="color:#f92672">`</span>, <span style="color:#f92672">`</span>age<span style="color:#f92672">`</span>)
</code></pre></div><p>当使用</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">select</span> id, name, age <span style="color:#66d9ef">from</span> student_tab <span style="color:#66d9ef">where</span> name <span style="color:#f92672">=</span> <span style="color:#f92672">`</span>Bob<span style="color:#f92672">`</span>;
</code></pre></div><p>查询的时候，name和age在一个联合索引上，所以在普通索引上是有age的信息的，这个时候就不需要回表。<br>
这就引入了下个问题，什么是覆盖索引。</p>
<h3 id="什么是覆盖索引">什么是覆盖索引？</h3>
<p>覆盖索引是一种避免回表查询的优化策略。具体做法就是将要查询的数据作为索引建立普通索引。
只需要在一棵索引树上就能获取SQL所需的所有列数据，无需回表，速度更快。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">TABLE</span> student_tab <span style="color:#66d9ef">DROP</span> <span style="color:#66d9ef">INDEX</span> idx_name;
<span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">TABLE</span> student_tab <span style="color:#66d9ef">ADD</span> <span style="color:#66d9ef">INDEX</span> idx_name_age(name, age);

<span style="color:#66d9ef">select</span> id, name, age <span style="color:#66d9ef">from</span> student_tab <span style="color:#66d9ef">where</span> name <span style="color:#f92672">=</span> <span style="color:#f92672">`</span>Bob<span style="color:#f92672">`</span>;
</code></pre></div><p>流程为：</p>
<ul>
<li>在name,age联合索引树上找到名称为<code>Bob</code>的节点</li>
<li>此时节点索引里包含信息 <code>name, age</code>, 节点对应的值为 主键索引 <code>id</code>。</li>
<li>包含我们所需要的所有信息，索引覆盖，无需回表。</li>
</ul>
<h3 id="确定数据库成功使用了覆盖索引呢">确定数据库成功使用了覆盖索引呢？</h3>
<p>使用explian查看 Extra 列是否是 <code>Using index</code>。</p>
<blockquote>
<p>Using index means that all information is returned from the index, without seeking the records in the table. This is only possible if all fields required by the query are covered by the index.</p>
</blockquote>
<p>意思是：Using index是指所有的信息可以从index里面返回，不需要从table中寻找记录。当且仅当所有查询需要的字段都覆盖在索引里面的时候才会存在。</p>
<p>当这个表有 索引 <code>INDEX idx_name (name)</code> 时：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">explain</span> <span style="color:#66d9ef">select</span> id, name <span style="color:#66d9ef">from</span> student_tab <span style="color:#66d9ef">where</span> name <span style="color:#f92672">=</span> <span style="color:#f92672">`</span>Bob<span style="color:#f92672">`</span>;
explian <span style="color:#66d9ef">select</span> id, name, age <span style="color:#66d9ef">from</span> student_tab <span style="color:#66d9ef">where</span> name <span style="color:#f92672">=</span> <span style="color:#f92672">`</span>Bob<span style="color:#f92672">`</span>;
</code></pre></div><p>
        <img class="mx-auto" alt="覆盖索引" src="/img/mysql/mysql_index.png" />   
    </p>
<p>发现如果查询 <code>age</code>的时候是无法使用覆盖索引的。</p>
<p>当这个表有 索引 INDEX <code>idx_name_age (name, age)</code> 时：</p>
<pre tabindex="0"><code>explian select id, name, age from student_tab where name = `Bob`;
</code></pre><p>
        <img class="mx-auto" alt="覆盖索引" src="/img/mysql/mysql_index2.png" />   
    </p>
<p>可以看到，<code>Extra = Using index</code>，这个时候就可以使用覆盖索引。</p>
<p>&lt;全文完&gt;</p>
<p>欢迎关注我的微信公众号：<strong>码农在新加坡</strong>，有更多好的技术分享。

        <img class="mx-auto" alt="pic" src="/img/personal/qrcode_2.png" />   
    </p>

        </div>

        


        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="/post/interview/mysql/">后端面试之MySQL</a></li>
        
        <li><a href="/post/mysql/dead_lock/">MySQL死锁的产生</a></li>
        
        <li><a href="/post/mysql/db_tidb_write_conflict/">TiDB Write Conflict问题分析</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='/tags/mysql'>MySQL</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "stormwy/blog-comments"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
</div>

                    <footer id="footer">
    <div>
        &copy; 2021 <a href="https://left-pocket.github.io">Leftpocket的个人博客 By leftpocket</a>
        
    </div>
    <br />
    <div>
        <div class="github-badge">
            <a href="https://gohugo.io/" target="_black" rel="nofollow"><span class="badge-subject">Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
        </div>
        <div class="github-badge">
            <a href="https://left-pocket.github.io/" target="_black"><span class="badge-subject">Design by</span><span class="badge-value bg-brightgreen">Leftpocket</span></a>
        </div>
    </div>
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>



    <script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='//www.google.com/search' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://left-pocket.github.io">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://left-pocket.github.io/post/mysql/covering_index/" title="后端面试之MySQL-什么是回表查询和覆盖索引">后端面试之MySQL-什么是回表查询和覆盖索引</a>
    </li>
    
    <li>
        <a href="https://left-pocket.github.io/post/interview/mysql/" title="后端面试之MySQL">后端面试之MySQL</a>
    </li>
    
    <li>
        <a href="https://left-pocket.github.io/post/interview/tcpip/" title="后端面试之网络编程">后端面试之网络编程</a>
    </li>
    
    <li>
        <a href="https://left-pocket.github.io/post/tcpip/socket_read_write/" title="后端面试之网络编程-socket可读可写条件">后端面试之网络编程-socket可读可写条件</a>
    </li>
    
    <li>
        <a href="https://left-pocket.github.io/post/algorithm/lru/" title="LRU缓存机制，你想知道的这里都有">LRU缓存机制，你想知道的这里都有</a>
    </li>
    
    <li>
        <a href="https://left-pocket.github.io/post/hugo/hugo_0/" title="从零开始搭建个人博客（零）- 序章">从零开始搭建个人博客（零）- 序章</a>
    </li>
    
    <li>
        <a href="https://left-pocket.github.io/post/cpp/do_while/" title="do{...}while(0)的用法">do{...}while(0)的用法</a>
    </li>
    
    <li>
        <a href="https://left-pocket.github.io/post/cpp/static/" title="c&#43;&#43;中static的用法详解">c&#43;&#43;中static的用法详解</a>
    </li>
    
    <li>
        <a href="https://left-pocket.github.io/post/game/game_development/" title="手游服务器开发技术详解">手游服务器开发技术详解</a>
    </li>
    
    <li>
        <a href="https://left-pocket.github.io/post/cpp/secondary_pointer/" title="二级指针的作用详解">二级指针的作用详解</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories/'>分类</a></h3>
<ul class="widget-list">
    
    <li><a href="https://left-pocket.github.io/categories/algorithm/">algorithm (2)</a></li>
    
    <li><a href="https://left-pocket.github.io/categories/c&#43;&#43;/">c&#43;&#43; (3)</a></li>
    
    <li><a href="https://left-pocket.github.io/categories/git/">git (1)</a></li>
    
    <li><a href="https://left-pocket.github.io/categories/golang/">Golang (5)</a></li>
    
    <li><a href="https://left-pocket.github.io/categories/hugo/">hugo (3)</a></li>
    
    <li><a href="https://left-pocket.github.io/categories/interview/">interview (1)</a></li>
    
    <li><a href="https://left-pocket.github.io/categories/leetcode/">leetcode (1)</a></li>
    
    <li><a href="https://left-pocket.github.io/categories/mysql/">MySQL (4)</a></li>
    
    <li><a href="https://left-pocket.github.io/categories/others/">Others (1)</a></li>
    
    <li><a href="https://left-pocket.github.io/categories/redis/">Redis (2)</a></li>
    
    <li><a href="https://left-pocket.github.io/categories/server/">server (2)</a></li>
    
    <li><a href="https://left-pocket.github.io/categories/vscode/">vscode (1)</a></li>
    
    <li><a href="https://left-pocket.github.io/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/">游戏开发 (1)</a></li>
    
    <li><a href="https://left-pocket.github.io/categories/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/">系统设计 (2)</a></li>
    
    <li><a href="https://left-pocket.github.io/categories/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/">网络编程 (1)</a></li>
    
    <li><a href="https://left-pocket.github.io/categories/%E9%9D%A2%E8%AF%95/">面试 (4)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags/'>标签</a></h3>
<div class="tagcloud">
    
    <a href="https://left-pocket.github.io/tags/algorithm/">algorithm</a>
    
    <a href="https://left-pocket.github.io/tags/c&#43;&#43;/">c&#43;&#43;</a>
    
    <a href="https://left-pocket.github.io/tags/db/">db</a>
    
    <a href="https://left-pocket.github.io/tags/git/">git</a>
    
    <a href="https://left-pocket.github.io/tags/golang/">Golang</a>
    
    <a href="https://left-pocket.github.io/tags/hugo/">hugo</a>
    
    <a href="https://left-pocket.github.io/tags/interview/">interview</a>
    
    <a href="https://left-pocket.github.io/tags/leetcode/">leetcode</a>
    
    <a href="https://left-pocket.github.io/tags/mysql/">MySQL</a>
    
    <a href="https://left-pocket.github.io/tags/redis/">Redis</a>
    
    <a href="https://left-pocket.github.io/tags/server/">Server</a>
    
    <a href="https://left-pocket.github.io/tags/snowflake/">snowflake</a>
    
    <a href="https://left-pocket.github.io/tags/ssr/">ssr</a>
    
    <a href="https://left-pocket.github.io/tags/vscode/">vscode</a>
    
    <a href="https://left-pocket.github.io/tags/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/">游戏开发</a>
    
    <a href="https://left-pocket.github.io/tags/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/">系统设计</a>
    
    <a href="https://left-pocket.github.io/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/">网络编程</a>
    
    <a href="https://left-pocket.github.io/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a>
    
    <a href="https://left-pocket.github.io/tags/%E9%9D%A2%E8%AF%95/">面试</a>
    
</div>
    </section>

    
<section class="widget">
    <h3 class="widget-title">友情链接</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="https://left-pocket.github.io/about/" title="关于我" style="color:#0000FF;">关于我-微信及公众号</a>
        </li>
        
        <li>
            <a target="_blank" href="https://www.zhihu.com/people/left-pocket" title="Leftpocket的知乎" style="color:#0000FF;">Leftpocket的知乎</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="https://left-pocket.github.io/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
</body>

</html>