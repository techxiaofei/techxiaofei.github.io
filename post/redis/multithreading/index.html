<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="referrer" content="no-referrer-when-downgrade">
    

    <title>一文看懂Redis 6.0多线程IO | Leftpocket的个人博客</title>
    <meta property="og:title" content="一文看懂Redis 6.0多线程IO - Leftpocket的个人博客">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2021-12-09T00:00:51&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2021-12-09T00:00:51&#43;08:00'>
        
    <meta name="Keywords" content="[Redis]">
    <meta name="description" content="一文看懂Redis 6.0多线程IO">
        
    <meta name="author" content="leftpocket">
    <meta property="og:url" content="https://left-pocket.github.io/post/redis/multithreading/">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    <meta name="baidu-site-verification" content="code-swx03nFBNS" />
    <meta name="google-site-verification" content="sGfWBA2Wby1_gxJO3xmOtvpAOU2cCyhwXuU-2m4u75Y" />

    
    <script data-ad-client="ca-pub-6791708134711137" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6791708134711137"
     crossorigin="anonymous"></script>
    
    
    
    
    
        <link rel="stylesheet" href='/css/douban.css'>
    
        <link rel="stylesheet" href='/css/other.css'>
    

    
    <meta name="baidu-site-verification" content="code-swx03nFBNS" />
</head>


<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://left-pocket.github.io">
                        Leftpocket的个人博客
                    </a>
                
                <p class="description">码农在新加坡</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://left-pocket.github.io">首页</a>
                    
                    <a  href="https://left-pocket.github.io/archives/" title="归档">归档</a>
                    
                    <a  href="https://left-pocket.github.io/about/" title="关于我">关于我</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    
    <article class="post">
        <header>
            <h1 class="post-title">一文看懂Redis 6.0多线程IO</h1>
        </header>
        <date class="post-meta meta-date">
            2021年12月9日
        </date>
        
        <div class="post-meta">
            <span>|</span>
            
            <span class="meta-category"><a href='/categories/redis'>Redis</a></span>
            
        </div>
        
        
        <div class="post-meta">
            <span id="busuanzi_container_page_pv">|<span id="busuanzi_value_page_pv"></span><span>
                    阅读</span></span>
        </div>
        
        
        <div class="post-content">
            <h1 id="redis基础">Redis基础</h1>
<h3 id="redis是什么">Redis是什么</h3>
<p>Redis是一个基于BSD开源的项目，是一个把结构化的数据放在内存中的一个存储系统。</p>
<p>你可以把它作为数据库，缓存和消息中间件来使用。同时支持<code>strings</code>，<code>lists</code>，<code>hashes</code>，<code>sets</code>，<code>sorted sets</code>，<code>bitmaps</code>，<code>hyperloglogs</code>和<code>geospatial indexes</code>等数据类型。</p>
<p>它还通过redis sentinel实现高可用，通过redis cluster实现了自动分片。以及事务，发布/订阅，自动故障转移等等。</p>
<h3 id="为什么用redis">为什么用Redis</h3>
<p>而在后端开发的技术选型中，Redis已经成为了一个不可绕过的解决方案工具。因此Redis成为了后端开发的基本技能之一。当然，也是后端面试中必考的技术栈之一。</p>
<p>Redis的优点，如果只用一个字来解释，那就是：快！</p>
<p>Redis 有多快？官方给出的答案是读写速度 10万/秒，如果说这是在单线程情况下跑出来的成绩，你会不会惊讶？为什么单线程的 Redis 速度这么快？</p>
<h3 id="redis为什么快">Redis为什么快</h3>
<p>主要有以下几点：</p>
<ol>
<li><strong>Redis 是基于内存的。</strong> 内存的读写速度非常快。当然Redis也存在持久化操作，但是是fork子进程和利用 Linux 系统的页缓存技术来完成，并不会影响Redis的读写性能。</li>
<li><strong>Redis 是单线程的。</strong> 避免了不必要的上下文切换和竞争条件，也不存在多进程或者多线程导致的切换而消耗 CPU，不用去考虑各种锁的问题，不存在加锁释放锁操作，没有因为可能出现死锁而导致的性能消耗。</li>
<li><strong>Redis 使用多路复用技术。</strong> 可以处理并发的连接。非阻塞 IO 部实现采用 epoll，采用了 epoll+自己实现的简单的事件框架。epoll 中的读、写、关闭、连接都转化成了事件，然后利用 epoll 的多路复用特性，绝不在 IO 上浪费一点时间。</li>
<li><strong>Redis 中的数据结构是专门进行设计的。</strong> 数据结构简单。对数据操作也简单。</li>
</ol>
<h3 id="redis是单线程的吗">Redis是单线程的吗</h3>
<p>我们经常听到，Redis是单线程的，这句话对吗？</p>
<p>基本上是对的，但是不准确。</p>
<p>而对于为什么使用单线程，官方有一句解释：</p>
<blockquote>
<p>It&rsquo;s not very frequent that CPU becomes your bottleneck with Redis, as usually Redis is either memory or network bound.</p>
</blockquote>
<p><strong>意思就是：</strong><br>
因为 Redis 是基于内存的操作，CPU 不是 Redis 的瓶颈。Redis 的瓶颈最有可能是机器内存的大小或者网络带宽。既然单线程容易实现，而且 CPU 不会成为瓶颈，那就顺理成章地采用单线程的方案了。</p>
<p>为什么说不准确呢？</p>
<p>我们需要回顾Redis的两个最重要的版本更新：</p>
<ol>
<li>
<p><code>Redis 4.0</code> 为了防止耗时的命令阻塞线程，导致无法处理后续事件。引入了多线程来处理一些非阻塞命令。有：<code>UNLINK</code>、<code>FLUSHALL ASYNC</code>、<code>FLUSHDB ASYNC</code>等。<br>
但是整个网络模型依然是单线程的，所以我们称之为单线程。</p>
</li>
<li>
<p><code>Redis 6.0</code> 就真正的在网络模型上加入<code>多线程IO</code>来解决网络IO的性能瓶颈。
此时IO读写是多线程的，执行命令依旧是单线程的。</p>
</li>
</ol>
<h3 id="redis网络模型">Redis网络模型</h3>
<p>一张图看懂Redis的单线程模型：</p>
<p>
        <img class="mx-auto" alt="redis" src="/img/redis/redis_io.png" />   
    </p>
<p>redis的网络事件处理器是基于Reactor模式，又叫做文件事件处理器。</p>
<p><code>文件事件处理器</code>使用<code>I/O多路复用</code>来同时监听多个套接字，并根据套接字执行的任务关联到不同的事件处理器。<br>
文件事件以单线程方式运行，但通过使用<code>I/O多路复用</code>程序来监听多个套接字，<code>文件事件处理器</code>实现了高性能的网络通信模型。<br>
Redis 在处理客户端的请求时，包括<code>接收</code>(socket读)、<code>解析</code>、<code>执行</code>、<code>发送</code>(socket 写) 等都由一个顺序串行的主线程处理，这就是所谓的<code>单线程</code>。</p>
<h1 id="reactor模型">Reactor模型</h1>
<p>Redis的单线程网络模型，这就是一个经典的Reactor的模型，其本质上是<code> I/O 多路复用(I/O multiplexing) + 非阻塞 I/O(non-blocking I/O)</code>的模式。</p>
<p>是一种基于事件驱动模型的设计模式。</p>
<p>我们来看一下Reactor里面两种经典的模型。</p>
<h3 id="单线程reactor模型">单线程Reactor模型</h3>
<p>Redis的单线程模型就是使用的经典的单线程Reactor模型。</p>
<p>我们先看看单线程的Reactor模型</p>
<p>
        <img class="mx-auto" alt="redis" src="/img/redis/reactor1.png" />   
    </p>
<p>消息处理流程：</p>
<ol>
<li>Reactor对象通过<code>select/poll/epoll</code>等IO多路复用监控连接事件，收到事件后通过<code>dispatcher</code>事件分发器进行转发。</li>
<li>如果是连接建立的事件，则由<code>acceptor</code>接受连接，并创建<code>Handler</code>处理后续事件。</li>
<li>如果不是建立连接事件，则Reactor会分发调用<code>Handler</code>来响应。</li>
<li>Handler会完成<code>read-&gt;解析-&gt;执行-&gt;send</code>的完整业务流程。</li>
</ol>
<p>优点：</p>
<ul>
<li>单线程运行，串行操作，不需要加锁，逻辑简单。</li>
</ul>
<p>缺点：</p>
<ul>
<li>仅用一个线程处理请求，对于多核资源机器来说是有点浪费的。</li>
<li>当处理读写任务的线程负载比较重，将会阻塞后续的事件处理，导致整体延迟变大。</li>
</ul>
<p>应用：</p>
<ul>
<li>Redis网络模型。（6.0版本以前）</li>
</ul>
<h3 id="master-worker-reactor模型">Master-Worker Reactor模型</h3>
<p>
        <img class="mx-auto" alt="redis" src="/img/redis/reactor2.png" />   
    </p>
<p>比起单线程模型，它是将Reactor分成两部分：</p>
<ul>
<li><code>mainReactor</code> 负责监听server socket，用来处理网络IO连接建立操作，将建立的socketChannel指定注册给subReactor。 <strong>（只负责监听）</strong></li>
<li><code>subReactor</code> 主要做和建立起来的socket做数据交互和事件业务处理操作。通常，subReactor个数上可与CPU个数等同。一般是多个，这样的话，就可以充分利用多核的优势。 <strong>（负责IO读写和命令的执行）</strong></li>
</ul>
<p>区别于<code>单线程Reactor模式</code>，这种模式不再是单线程的事件循环，而是有多个线程<code>subReactors</code>各自维护一个独立的事件循环，由 <code>mainReactor</code> 负责接收新连接并分发给 <code>subReactors</code> 去独立处理，最后 <code>subReactors</code> 回写响应给客户端。</p>
<p>优点：</p>
<ul>
<li>响应快，不必为单个同步时间所阻塞，虽然Reactor本身依然是同步的；</li>
<li>可扩展性，可以方便地通过增加Reactor实例个数来充分利用CPU资源；</li>
</ul>
<p>缺点：</p>
<ul>
<li>如果多个线程可能操作同一份数据，就涉及到底层数据同步的问题，则必然会引入某些同步机制，比如锁。增加了代码复杂度，同时增加了同步机制的开销。</li>
</ul>
<p>应用：</p>
<ul>
<li>Nginx, Netty, Swoole, Memcached就是使用的这个模型</li>
</ul>
<h1 id="redis-60的多线程网络模型">Redis 6.0的多线程网络模型</h1>
<p>Redis 6.0版本之后，Redis 正式在核心网络模型中引入了多线程，也就是所谓的 <code>I/O threading</code>，至此 Redis 真正拥有了多线程模型。
但是Redis的多线程模型却并非标准的<code>Master-Worker Reactor</code>模型。他的多线程 <strong>只负责IO读写，不负责具体的执行。</strong></p>
<h3 id="为什么redis-60-要使用多线程">为什么Redis 6.0 要使用多线程</h3>
<p>之前说了，CPU不是Redis的瓶颈，Redis的瓶颈最有可能是机器内存大小和网络带宽。
从Redis自身角度来说，因为读写网络的<code>read/write</code>系统调用占用了Redis执行期间大部分CPU时间，瓶颈主要在于网络的 IO 消耗, 所以选择多线程IO来实现读写。主线程来执行Redis命令。</p>
<p><strong>总结就是：</strong><br>
将主线程 IO 读写任务拆分出来给一组独立的线程处理，使得多个 socket 读写可以并行化，但是 Redis 命令还是主线程串行执行。</p>
<h3 id="redis-60-网络模型">Redis 6.0 网络模型</h3>
<p>
        <img class="mx-auto" alt="redis" src="/img/redis/reactor3.png" />   
    </p>
<p><strong>为什么这么设计呢？</strong></p>
<ol>
<li>前面提到 Redis 最初选择单线程网络模型的理由是：CPU 通常不会成为性能瓶颈，瓶颈往往是内存和网络，因此单线程足够了。那么为什么现在 Redis 又要引入多线程呢？很简单，就是 Redis 的<code>网络 I/O 瓶颈</code>已经越来越明显了。所以这个多线程是为了<code>解决IO的瓶颈</code>的。</li>
<li>如果多线程包括了<code>IO读写，解析和执行</code>的整个过程，那么多线程需要面临线程安全的问题，Redis 6.0版本之前是没有考虑线程安全的，如果使用多线程来处理命令的执行，需要大量的改动来保证多线程的安全机制，实现更复杂。为了避免了不必要的上下文切换和竞争条件，多线程导致的切换而消耗 CPU，也不用考虑各种锁的问题，就让执行这一步只使用主线程。</li>
</ol>
<h3 id="redis-60和memcached多线程模型对比">Redis 6.0和Memcached多线程模型对比</h3>
<p>相同点：</p>
<ul>
<li>都采用了 Master-Worker 的线程的模型</li>
</ul>
<p>不同点：</p>
<ul>
<li>Memcached 执行主逻辑也是在 Worker 线程里，模型更加简单，实现了真正的线程隔离，通过各种锁机制来保证数据的线程安全。</li>
<li>而 Redis 把执行逻辑交还给 Master 线程，虽然一定程度上增加了模型复杂度，但也解决了数据的线程安全问题。</li>
</ul>
<h1 id="总结">总结</h1>
<p>让我们来回顾一下 Redis 多线程网络模型的设计方案：</p>
<ul>
<li>使用 I/O 线程实现网络 I/O 多线程化，I/O 线程只负责网络 I/O 和命令解析，不执行具体的命令。</li>
</ul>
<p>Redis 的多线程网络模型实际上并不是一个标准的 <code>Master-Worker Reactor</code> 模型，Redis 的多线程方案中，I/O 线程任务仅仅是通过 socket 读取客户端请求命令并解析，却没有真正去执行命令。</p>
<p>所有客户端命令最后还需要回到<code>主线程去执行</code>，因此对多核的利用率并不算高，而且每次主线程都必须在分配完任务之后忙轮询等待所有 I/O 线程完成任务之后才能继续执行其他逻辑。</p>
<p>Redis 目前的多线程方案更像是一个折中的选择：既保持了原系统的兼容性，又能利用多核提升 I/O 性能，来解决网络IO的性能瓶颈。</p>
<p>&lt;全文完&gt;</p>
<p>欢迎关注我的微信公众号：<strong>码农在新加坡</strong>，有更多好的技术分享。

        <img class="mx-auto" alt="pic" src="/img/personal/qrcode_2.png" />   
    </p>

        </div>

        


        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="/post/redis/redis_sds/">Redis SDS简单动态字符串</a></li>
        
        <li><a href="/post/redis/redis_zset_score/">Redis Zset的精度问题分析及解决方案</a></li>
        
        <li><a href="/post/system_design/bloom_filter/">5分钟搞懂布隆过滤器，掌握亿级数据过滤算法</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='/tags/redis'>Redis</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "left-pocket/left-pocket.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
</div>

                    <footer id="footer">
    <div>
        &copy; 2021 <a href="https://left-pocket.github.io">Leftpocket的个人博客 By leftpocket</a>
        
    </div>
    <br />
    <div>
        <div class="github-badge">
            <a href="https://gohugo.io/" target="_black" rel="nofollow"><span class="badge-subject">Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
        </div>
        <div class="github-badge">
            <a href="https://left-pocket.github.io/" target="_black"><span class="badge-subject">Design by</span><span class="badge-value bg-brightgreen">Leftpocket</span></a>
        </div>
    </div>
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>



    <script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




    <script src='/js/douban.js'></script>

                </div>

                <div id="secondary">
    
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://left-pocket.github.io/post/redis/multithreading/" title="一文看懂Redis 6.0多线程IO">一文看懂Redis 6.0多线程IO</a>
    </li>
    
    <li>
        <a href="https://left-pocket.github.io/post/linux/cp/" title="后端面试之Linux-cp和mv命令的区别">后端面试之Linux-cp和mv命令的区别</a>
    </li>
    
    <li>
        <a href="https://left-pocket.github.io/post/mysql/table/" title="MySQL对于千万级的大表要怎么优化？">MySQL对于千万级的大表要怎么优化？</a>
    </li>
    
    <li>
        <a href="https://left-pocket.github.io/post/backend/game_server/" title="游戏服务器和普通服务器的区别">游戏服务器和普通服务器的区别</a>
    </li>
    
    <li>
        <a href="https://left-pocket.github.io/post/mysql/innodb/" title="后端面试之MySQL-InnoDB一颗B&#43;树可以存放多少行数据？">后端面试之MySQL-InnoDB一颗B&#43;树可以存放多少行数据？</a>
    </li>
    
    <li>
        <a href="https://left-pocket.github.io/post/hugo/hugo_dns/" title="从零开始搭建个人博客（五）- 申请免费域名并绑定到个人博客">从零开始搭建个人博客（五）- 申请免费域名并绑定到个人博客</a>
    </li>
    
    <li>
        <a href="https://left-pocket.github.io/post/hugo/hugo_vercel/" title="从零开始搭建个人博客（四）- hugo自动部署到vercel">从零开始搭建个人博客（四）- hugo自动部署到vercel</a>
    </li>
    
    <li>
        <a href="https://left-pocket.github.io/post/hugo/hugo_advanced/" title="从零开始搭建个人博客（三）- hugo高级配置，让博客更亮眼">从零开始搭建个人博客（三）- hugo高级配置，让博客更亮眼</a>
    </li>
    
    <li>
        <a href="https://left-pocket.github.io/post/hugo/hugo_github/" title="从零开始搭建个人博客（二）- 把hugo博客托管到github上">从零开始搭建个人博客（二）- 把hugo博客托管到github上</a>
    </li>
    
    <li>
        <a href="https://left-pocket.github.io/post/hugo/hugo_creation/" title="从零开始搭建个人博客（一）- 使用hugo搭建个人博客">从零开始搭建个人博客（一）- 使用hugo搭建个人博客</a>
    </li>
    
</ul>
    </section>

    

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories/'>分类</a></h3>
<ul class="widget-list">
    
    <li><a href="https://left-pocket.github.io/categories/c&#43;&#43;/">c&#43;&#43; (3)</a></li>
    
    <li><a href="https://left-pocket.github.io/categories/git/">git (1)</a></li>
    
    <li><a href="https://left-pocket.github.io/categories/golang/">Golang (4)</a></li>
    
    <li><a href="https://left-pocket.github.io/categories/hugo/">hugo (6)</a></li>
    
    <li><a href="https://left-pocket.github.io/categories/leetcode/">leetcode (1)</a></li>
    
    <li><a href="https://left-pocket.github.io/categories/linux/">Linux (1)</a></li>
    
    <li><a href="https://left-pocket.github.io/categories/mysql/">MySQL (5)</a></li>
    
    <li><a href="https://left-pocket.github.io/categories/others/">Others (1)</a></li>
    
    <li><a href="https://left-pocket.github.io/categories/redis/">Redis (3)</a></li>
    
    <li><a href="https://left-pocket.github.io/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发 (2)</a></li>
    
    <li><a href="https://left-pocket.github.io/categories/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/">系统设计 (4)</a></li>
    
    <li><a href="https://left-pocket.github.io/categories/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/">网络编程 (1)</a></li>
    
    <li><a href="https://left-pocket.github.io/categories/%E9%9D%A2%E8%AF%95/">面试 (2)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags/'>标签</a></h3>
<div class="tagcloud">
    
    <a href="https://left-pocket.github.io/tags/c&#43;&#43;/">c&#43;&#43;</a>
    
    <a href="https://left-pocket.github.io/tags/git/">git</a>
    
    <a href="https://left-pocket.github.io/tags/golang/">Golang</a>
    
    <a href="https://left-pocket.github.io/tags/hugo/">hugo</a>
    
    <a href="https://left-pocket.github.io/tags/leetcode/">leetcode</a>
    
    <a href="https://left-pocket.github.io/tags/linux/">Linux</a>
    
    <a href="https://left-pocket.github.io/tags/mysql/">MySQL</a>
    
    <a href="https://left-pocket.github.io/tags/redis/">Redis</a>
    
    <a href="https://left-pocket.github.io/tags/vscode/">vscode</a>
    
    <a href="https://left-pocket.github.io/tags/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a>
    
    <a href="https://left-pocket.github.io/tags/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/">系统设计</a>
    
    <a href="https://left-pocket.github.io/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/">网络编程</a>
    
    <a href="https://left-pocket.github.io/tags/%E9%9D%A2%E8%AF%95/">面试</a>
    
</div>
    </section>

    
<section class="widget">
    <h3 class="widget-title">友情链接</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="https://left-pocket.github.io/about/" title="关于我" style="color:#0000FF;">关于我-微信及公众号</a>
        </li>
        
        <li>
            <a target="_blank" href="https://www.zhihu.com/people/left-pocket" title="Leftpocket的知乎" style="color:#0000FF;">Leftpocket的知乎</a>
        </li>
        
    </ul>
</section>


    
</div>
            </div>
        </div>
    </div>
</body>

</html>